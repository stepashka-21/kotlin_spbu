# Курс объектно-ориентированного программирования на МКН СПбГУ
## Занятие 5: рефакторинг кода к объектно-ориентированному стилю

На этом занятии мы будем рефакторить пример из лекции по курсу «Основы программирования» 
(и книги Мaртина Фаулера «Рефакторинг»), используя приемы и шаблоны ООП.

### План занятия
1. Создание индивидуального репозитория для занятия на GitHub и его импорт в локальный проект в IntelliJ IDEA
2. Локальная работа с проектом: редактирование, запуск програмы и тестирование, отправка решения на сервер
3. Создание пулл-реквеста (на ветку `task`) по готовности решения

### Описание предметной области

В этой программе формируется счет (statement), выставленный некоторому клиенту за оказанные ему услуги
по организации театральных представлений (performance). Счет выставляется на основании заказ-наряда (invoice), содержащего
информацию о конкретных представлениях и фактическом количестве слушателей (audience). Стоимость представления
зависит от типа представленной пьесы (комедии, трагедии) и от количества слушателей. Также при выставлении счета 
определяется количество бонусов (credit), которые можно использовать при оплате следующих счетов. Счет форматируется
в текстовом виде и выводится на консоль.

### Этапы работы

1. **Вычисление стоимости представления и начисляемых бонусов (`calculators.kt`).**
    
   1. Определите интерфейс и его реализации для вычисления стоимости представления и начисляемых бонусов по типам пьес.
   Замените текущее вычисление стоимости представления (`amountFor`) и начисляемых бонусов (`volumeCreditsFor`)
   на использование реализаций интерфейса. Ваши изменения не должны затрагивать другие части программы.
   3. Добавьте тесты для калькуляторов разных видов.
   2. Убедитесь, что все тесты проходят, сделайте коммит, и отправьте изменения на сервер.
    
2. **Замена типа пьесы на соответствующий калькулятор**

   1. Замените свойство `Play::type` на интерфейс для калькулятора, инстанцируйте его нужным образом в списке
      `PLAYS` и выполните соответствующие преобразования в других частях программы.
   2. Обратите внимание, что по сути мы стали определять конкретный вид калькулятора раньше, на этапе
      создания объекта пьесы, а не в момент вычисления.
   4. Убедитесь, что все тесты проходят, сделайте коммит, и отправьте изменения на сервер.

3. **Загрузка пьес из CSV-файла**
   1. Организуйте загрузку списка пьес из CSV-файла следующего формата: 
   ```
   hamlet,Hamlet,tragedy
   as-like,As You Like it,comedy
   othello,Othello,tragedy
   ```
   2. Воспользуйтесь упрощённой версией шаблона `AbstractFactory` (с одной фабрикой и одной функцией создания) 
      для создания калькуляторов по строке с типом
      пьесы из файла, сделав при этом так, чтобы калькулятор для одного типа создавался не более одного раза. 
   3. Ваша основная программа должна выглядеть следующим образом: 
      1. Загрузка пьес из CSV-файла (можно с фиксированным названием) с пьесами в переменную `plays`.
      2. Формирование и печать счета.

   4. Убедитесь, что все тесты проходят, исправьте значение поля `"points"` в [файле автогрейдинга](./.github/classroom/autograding.json) 
      на `2`, сделайте коммит, и отправьте изменения на сервер.
   5. Подумайте, а что если в какой-то момент от нас потребуют реализовать возможность загрузки данных из JSON-файла?
      А из базы данных? Какое решение вы предложите в этом случае?
4. **Ссылки на пьесы в представлениях**
   1. Текущий способ организации связи между представлением и пьесой через `playID` унаследован от способа 
      представления данных. В объектно-ориентированной программе для этого обычно используют прямые ссылки.
      Измените определение класса `Performance` соответствующим образом и обеспечьте создание его экземпляров,
      при котором пьесы берутся из уже имеющегося списка пьес (новые экземпляры класса `Play` создавать нельзя).
      Сделайте также связанные с этими изменениями правки в других частях программы.
   2. Организуйте загрузку списка представлений в заказ-наряде из CSV-файла.
   3. Убедитесь, что у вас в коде не остались оказавшиеся ненужными параметры и функции (в том числе вложенные). 
   4. Убедитесь, что все тесты проходят, исправьте значение поля `"points"` в [файле автогрейдинга](./.github/classroom/autograding.json)
      на `3`, сделайте коммит, и отправьте изменения на сервер.
5. **Отображение счетов в HTML**
   1. Организуйте отображение счетов в HTML, например:
   ```html
   <!DOCTYPE html>
   <html>
      <head>
         <meta charset="utf-8" />
         <title>Statement for BigCo</title>
      </head>
      <body>
        <h1>Statement for BigCo</h1>
        <table>
            <thead>
                <td>Play</td><td>Amount</td><td>Seats</td>
            </thead>
            <tr>
                <td>Hamlet</td><td>$650.00</td><td>55</td>
            </tr>
            <tr>
                <td>As You Like it</td><td>$580.00</td><td>35</td>
            </tr>
            <tr>
                <td>Othello</td><td>$500.00</td><td>40</td>
            </tr>
        </table>
        <p>Amount owed is $1,730.00</p>
        <p>You earned 47 credits</p>
      </body>
   </html>
   ```
   2. Модифицируйте функцию `statement` так, чтобы способ отображения счета зависел от её параметров. Используйте
   объектно-ориентированные подходы.
   3. Добавьте тест для отображения счета в формате HTML.
   4. Убедитесь, что все тесты проходят, исправьте значение поля `"points"` в [файле автогрейдинга](./.github/classroom/autograding.json)
      на `4`, сделайте коммит, и отправьте изменения на сервер.

6. **Скриптовый движок** (обязательно, только если осталось время на занятии).

   Организуйте работу программы в соответствии со скриптами следующего вида:
   ```
   load plays csv plays.csv
   add play midsummer-night-dream,A Midsummer Night's Dream,comedy
   load invoice csv BigCo invoice.csv
   add performance midsummer-night-dream,45
   add performance midsummer-night-dream,35
   print statement text
   print statement html
   ```
   Вы должны загружать скрипт и выполнять все указанные в нём действия. В реализации вам может помочь шаблон `Command`.

### Начисление баллов за занятие

* Один балл за этапы 1–2, по одному баллу за каждый этап 3–5.